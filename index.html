<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Log Pro - Event Management System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/Jehuti-ms/event-log-pro/main/icon.svg">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Jehuti-ms/event-log-pro/main/icon-192.png">
    
    <!-- Apple Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Event Log Pro">
    
    <!-- Description -->
    <meta name="description" content="Comprehensive event management system for field trips, tours, and student events with Google Sheets integration">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <script>
         console.log('üîß Script loading check:');
    console.log('üìç window.collectFormData:', typeof window.collectFormData);
    console.log('üìç window.initializeAutoSync:', typeof window.initializeAutoSync);
    console.log('üìç window.AutoSync:', typeof window.AutoSync);
    
    // Test if we can manually initialize
    setTimeout(() => {
        console.log('üß™ Testing manual AutoSync initialization...');
        if (typeof initializeAutoSync === 'function') {
            console.log('‚úÖ initializeAutoSync is available, calling it...');
            initializeAutoSync();
        } else {
            console.error('‚ùå initializeAutoSync is NOT available');
        }
    }, 3000);
        
        // CRITICAL: Check auth IMMEDIATELY to prevent flash
        (function() {
            if (localStorage.getItem('isAuthenticated') === 'true') {
                document.body.classList.add('authenticated');
            }
        })();
    </script>
    
    <div id="landingPage" class="landing-page">
        <div class="landing-content">
            <div class="landing-logo">üìö</div>
            <h1>Event Log Pro</h1>
            <h2>Event Management System</h2>
            <p>Manage field trips, tours, and student events efficiently with our comprehensive tracking system.</p>
            <button onclick="handleGoogleSignIn()" class="google-signin-btn">
                <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>
            <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">First time? Just click the button to get started!</p>
        </div>
    </div>

    <div id="spinner" class="spinner">
        <div class="spinner-content">
            <div class="loader"></div>
            <div id="spinnerText">Processing...</div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
            </div>
            <div class="modal-body">
                <div class="settings-grid">
                    <div class="settings-section">
                        <h3>üì° Web App Connection</h3>
                        <div class="form-group">
                            <label for="settingsApiUrl"><strong>Google Apps Script Web App URL</strong></label>
                            <input type="text" id="settingsApiUrl" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec">
                            <small class="help-text">Deploy your Google Apps Script as a web app and paste the URL here</small>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>üìä Google Sheet Configuration</h3>
                        <div class="form-group">
                            <label for="settingsSheetId"><strong>Google Sheet ID</strong></label>
                            <input type="text" id="settingsSheetId" placeholder="Your Google Sheet ID">
                            <small class="help-text">Find this in your sheet URL: docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</small>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            <small style="color: #856404;">
                                <strong>‚ö†Ô∏è Important:</strong> Add this Sheet ID to your Apps Script project properties as <code>SHEET_ID</code>
                            </small>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>üìÑ Google Doc Configuration</h3>
                        <div class="form-group">
                            <label for="settingsDocId"><strong>Google Doc Template ID (Optional)</strong></label>
                            <input type="text" id="settingsDocId" placeholder="Your Google Doc Template ID">
                            <small class="help-text">For custom report templates. Leave blank to auto-create new docs.</small>
                        </div>
                    </div>
                </div>
                
                <div id="connectionStatus"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button onclick="testConnection()" class="btn-info">üîç Test Connection</button>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeSettings()" class="btn-secondary">Close</button>
                <button onclick="saveSettings()" class="btn-primary">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <header>
            <div class="school-header-icon">üéì</div>
            <h1>Event Log Pro</h1>
            <h2>Comprehensive Event Management</h2>
            <h3 class="form-title">Event / Tour Data Sheet</h3>
            <p id="eventIdDisplay">Event ID: (new)</p>

                        <div class="header-controls">
                <button onclick="handleLogout()" class="settings-btn">üö™ Logout</button>
                <button onclick="openSettings()" class="settings-btn">‚öôÔ∏è Settings</button>
                <button onclick="autoSync.forceSync()" class="settings-btn" title="Force Sync" id="syncButton">üîÑ Sync Now</button>
                <div id="syncIndicator" class="sync-indicator offline" title="Offline"></div>
                <div class="theme-toggle-wrapper">
                    <span class="toggle-text">Dark Mode</span>
                    <div class="theme-toggle">
                        <input type="checkbox" id="darkModeToggle">
                        <label for="darkModeToggle" class="toggle-label">
                            <span class="toggle-icon sun">‚òÄÔ∏è</span>
                            <span class="toggle-icon moon">üåô</span>
                            <span class="toggle-ball"></span>
                        </label>
                    </div>
                </div>
            </div>
        </header>
        <!-- Sync Status Bar -->
        <div id="syncStatusBar" class="sync-status-bar">
            <span id="syncStatusText">Checking connection...</span>
            <span id="lastSyncTime"></span>
        </div>
        
        <form id="eventForm">
            <input type="hidden" id="eventId" name="eventId">

            <div class="form-row">
                <div class="form-group">
                    <label for="eventName">Event Name *</label>
                    <input type="text" id="eventName" name="eventName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="eventDate">Date *</label>
                    <input type="date" id="eventDate" name="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventVenue">Venue</label>
                    <input type="text" id="eventVenue" name="eventVenue">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="departureTime">Departure Time</label>
                    <input type="time" id="departureTime" name="departureTime">
                </div>
                <div class="form-group">
                    <label for="returnTime">Return Time</label>
                    <input type="time" id="returnTime" name="returnTime">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="company">Company</label>
                    <input type="text" id="company" name="company">
                </div>
                <div class="form-group">
                    <label for="vehicle">Vehicle No.</label>
                    <input type="text" id="vehicle" name="vehicle">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="accompanying">Accompanying Teachers</label>
                    <input type="text" id="accompanying" name="accompanying" placeholder="Enter teacher names separated by commas">
                    <small class="help-text">e.g., Ms. Smith, Mr. Jones, Dr. Brown</small>
                </div>
            </div>

            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" id="totalStudents">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">No. Teachers</div>
                    <div class="stat-value" id="numTeachers">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Present</div>
                    <div class="stat-value" id="presentCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Permission Slips</div>
                    <div class="stat-value" id="permissionCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total People</div>
                    <div class="stat-value" id="totalPeople">0</div>
                </div>
            </div>

           <!-- Student List Section with Search and Scroll -->
<h4 style="margin-top: 30px; margin-bottom: 15px;">
    Student List 
    <span id="studentCountBadge" style="font-size: 0.7em; background: #0078d7; color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">0 students</span>
</h4>

<!-- Search Bar -->
<div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
    <input type="text" id="studentSearch" placeholder="üîç Search students by name, form, or contact..." style="padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; flex: 1; font-size: 14px;">
    <button onclick="clearSearch()" class="btn-secondary" style="padding: 10px 15px; white-space: nowrap;">Clear Search</button>
</div>

<!-- Scrollable Table Container -->
<div class="table-scroll-container" id="studentTableContainer">
    <table id="studentTable">
        <thead class="sticky-header">
            <tr>
                <th>#</th>
                <th>Student Name</th>
                <th>Form</th>
                <th>Contact Number</th>
                <th>Medical / Illness</th>
                <th>Medication</th>
                <th>Permission</th>
                <th>Present</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td><input type="text" name="studentName[]"></td>
                <td><input type="text" name="form[]"></td>
                <td><input type="text" name="contact[]"></td>
                <td>
                    <select name="illness[]" class="student-illness">
                        <option value="None">None</option>
                        <option value="Asthma">Asthma</option>
                        <option value="Allergies ‚Äì Mild">Allergies ‚Äì Mild</option>
                        <option value="Allergies ‚Äì Severe / Anaphylaxis">Allergies ‚Äì Severe / Anaphylaxis</option>
                        <option value="Epilepsy / Seizure disorder">Epilepsy / Seizure disorder</option>
                        <option value="Diabetes">Diabetes</option>
                        <option value="Heart condition">Heart condition</option>
                        <option value="Other (specify)">Other (specify)</option>
                    </select>
                    <input type="text" name="illnessOther[]" class="illness-other" placeholder="Describe other illness" style="display:none; margin-top: 5px; width: 100%;">
                </td>
                <td>
                    <input type="checkbox" name="medication[]" class="medication-checkbox">
                    <input type="text" name="medicationDetails[]" class="medication-details" placeholder="Medication details" style="display:none; margin-top: 5px; width: 100%;">
                </td>
                <td><input type="checkbox" name="permission[]"></td>
                <td><input type="checkbox" name="present[]"></td>
                <td><button type="button" class="delete-row">‚úñ</button></td>
            </tr>
        </tbody>
    </table>
    <div class="student-counter" id="studentCounter">Total Students: 1</div>
</div>

<button type="button" class="add-row" onclick="addStudentRow()">+ Add Student</button>
            
            <div class="form-group">
                <label for="eventSelect">Load Existing Event</label>
                <select id="eventSelect" onchange="loadSelectedEvent()">
                    <option value="">-- Select an event --</option>
                </select>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-primary" onclick="newEvent()">‚ûï New Event</button>
                <button type="button" class="btn-primary" onclick="saveEvent()">üíæ Save Event</button>
                <button type="button" class="btn-success" onclick="editEvent()">‚úèÔ∏è Edit</button>
                <button type="button" class="btn-secondary" onclick="promptLoadEvent()">üìÇ Load Event</button>
                <button type="button" class="btn-danger" onclick="deleteEvent()">üóëÔ∏è Delete Event</button>
                <button type="button" class="btn-info" onclick="generateReport()">üìÑ Generate Report</button>
            </div>
        </form>
    </div>

    <!-- JavaScript Files -->
<!--<script src="app.js"></script>
<script src="table-enhancements.js"></script>
<script src="auto-sync.js"></script> -->

    <script>
// ============================================
// COMBINED ENHANCEMENTS - INLINE VERSION
// ============================================

console.log('üö® INLINE ENHANCEMENTS: Starting...');

// Wait for everything to be ready
function initializeEnhancements() {
    console.log('üéØ Checking for table and authentication...');
    
    const table = document.getElementById('studentTable');
    const mainContainer = document.getElementById('mainContainer');
    
    if (!table || !mainContainer || mainContainer.style.display === 'none') {
        console.log('‚è≥ Waiting for table/auth...');
        setTimeout(initializeEnhancements, 500);
        return;
    }
    
    console.log('‚úÖ Ready! Activating enhancements...');
    activateTableFeatures();
    activateAutoSync();
}

function activateTableFeatures() {
    console.log('üìä Activating table features...');
    
    const searchInput = document.getElementById('studentSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#studentTable tbody tr');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const name = row.cells[1]?.querySelector('input')?.value.toLowerCase() || '';
                const form = row.cells[2]?.querySelector('input')?.value.toLowerCase() || '';
                const contact = row.cells[3]?.querySelector('input')?.value.toLowerCase() || '';
                
                const matches = name.includes(term) || form.includes(term) || contact.includes(term) || term === '';
                row.style.display = matches ? '' : 'none';
                if (matches) visibleCount++;
            });
            
            updateStudentCounter();
            console.log(`üîç Filtered: ${visibleCount} students`);
        });
        console.log('‚úÖ Search activated');
    }
    
    updateStudentCounter();
    
    // Auto-update counter
    const tableBody = document.querySelector('#studentTable tbody');
    if (tableBody) {
        const observer = new MutationObserver(updateStudentCounter);
        observer.observe(tableBody, { childList: true, subtree: true });
        console.log('‚úÖ Auto-counter enabled');
    }
}

function updateStudentCounter() {
    const rows = document.querySelectorAll('#studentTable tbody tr');
    const searchInput = document.getElementById('studentSearch');
    const searchTerm = searchInput ? searchInput.value.trim() : '';
    
    let validStudents = 0;
    let visibleStudents = 0;
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const nameInput = row.cells[1]?.querySelector('input');
            const hasName = nameInput && nameInput.value.trim() !== '';
            
            if (hasName) {
                validStudents++;
                visibleStudents++;
            }
        }
    });
    
    const counter = document.getElementById('studentCounter');
    const badge = document.getElementById('studentCountBadge');
    
    if (counter) {
        counter.textContent = searchTerm ? 
            `Showing: ${visibleStudents} of ${validStudents} students` : 
            `Total Students: ${validStudents}`;
    }
    
    if (badge) {
        badge.textContent = `${validStudents} student${validStudents !== 1 ? 's' : ''}`;
    }
}

function activateAutoSync() {
    console.log('üîÑ Activating auto-sync...');
    
    let syncTimer;
    
    function debouncedSync() {
        if (syncTimer) clearTimeout(syncTimer);
        showSyncStatus('syncing');
        
        syncTimer = setTimeout(() => {
            showSyncStatus('success');
            console.log('üíæ Auto-saved changes');
        }, 1500);
    }
    
    // Listen for all input changes
    document.addEventListener('input', function(e) {
        if (e.target.closest('#studentTable') || e.target.closest('#eventForm')) {
            debouncedSync();
        }
    });
    
    // Create status indicator
    if (!document.getElementById('autoSyncStatus')) {
        const statusHTML = `
            <div id="autoSyncStatus" style="position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 15px; border-radius: 8px; font-size: 12px; z-index: 10000; display: none; align-items: center; gap: 8px;">
                <span id="syncStatusIcon">‚ö°</span>
                <span id="syncStatusText">Auto-sync ON</span>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', statusHTML);
    }
    
    showSyncStatus('ready');
    console.log('‚úÖ Auto-sync active');
}

function showSyncStatus(status) {
    const element = document.getElementById('autoSyncStatus');
    if (!element) return;
    
    const icon = document.getElementById('syncStatusIcon');
    const text = document.getElementById('syncStatusText');
    
    switch(status) {
        case 'syncing': 
            element.style.background = '#f59e0b';
            icon.textContent = '‚è≥';
            text.textContent = 'Auto-saving...';
            break;
        case 'success':
            element.style.background = '#10b981';
            icon.textContent = '‚úÖ';
            text.textContent = 'Auto-saved';
            setTimeout(() => element.style.display = 'none', 2000);
            break;
        case 'ready':
            element.style.background = '#6b7280';
            icon.textContent = '‚ö°';
            text.textContent = 'Auto-sync ON';
            setTimeout(() => element.style.display = 'none', 3000);
            break;
    }
    
    element.style.display = 'flex';
}

// Global functions
window.clearSearch = function() {
    const searchInput = document.getElementById('studentSearch');
    if (searchInput) {
        searchInput.value = '';
        const rows = document.querySelectorAll('#studentTable tbody tr');
        rows.forEach(row => row.style.display = '');
        updateStudentCounter();
        console.log('üßπ Search cleared');
    }
};

// Start everything
setTimeout(initializeEnhancements, 1000);

console.log('üö® INLINE ENHANCEMENTS: Loaded successfully!');
</script>
</body>
</html>









